<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bihar Form 16 Generator Pro V11</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #1b5e20; --secondary: #2e7d32; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: transparent; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 20px; text-align: center; border-radius: 12px 12px 0 0; }
        .steps { display: flex; background: #f8f9fa; padding: 15px 10px; border-bottom: 1px solid #e0e0e0; overflow-x: auto; }
        .step { flex: 1; min-width: 80px; text-align: center; font-size: 11px; color: #6c757d; font-weight: 500; }
        .step.active { color: var(--primary); font-weight: 700; border-bottom: 2px solid var(--primary); padding-bottom: 5px; }
        .content { padding: 25px; }
        .page { display: none; } .page.active { display: block; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 2.5px solid #e0e0e0; border-radius: 8px; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-secondary { background: #757575; color: white; margin-top: 5px; }
        .upper { text-transform: uppercase; }
        .summary-box { background: #e8f5e9; border: 2px solid var(--primary); padding: 15px; border-radius: 10px; margin-top: 20px; }
        #pdf-wrapper { display: none; } 
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container" id="mainUI">
        <div class="header">
            <h1>üéì Bihar Teacher TDS System V11</h1>
            <p>Official 2-Page Fillable PDF Generator</p>
        </div>

        <div class="steps">
            <div class="step active" id="s1">District</div>
            <div class="step" id="s2">Personal</div>
            <div class="step" id="s3">Salary</div>
            <div class="step" id="s4">Verification</div>
            <div class="step" id="s5">Download</div>
        </div>

        <div class="content">
            <div id="p1" class="page active">
                <div class="form-row">
                    <div>
                        <label>District *</label>
                        <select id="district" onchange="loadDist()">
                            <option value="">Select District</option>
                            <option value="Gopalganj">GOPALGANJ</option>
                            <option value="Siwan">SIWAN</option>
                            <option value="Patna">PATNA</option>
                            <option value="Gaya">GAYA</option>
                            <option value="Muzaffarpur">MUZAFFARPUR</option>
                            <option value="custom">Others (‡§Ö‡§®‡•ç‡§Ø)</option>
                        </select>
                    </div>
                    <div>
                        <label>Assessment Year *</label>
                        <select id="ay">
                            <option value="2026-27">2026-27</option>
                            <option value="2027-28">2027-28</option>
                            <option value="2028-29">2028-29</option>
                            <option value="2029-30">2029-30</option>
                        </select>
                    </div>
                </div>
                <div id="cDistDiv" style="display:none" class="form-group">
                    <label>District Name *</label>
                    <input type="text" id="distName" class="upper" placeholder="ENTER DISTRICT NAME">
                </div>
                <div class="form-row">
                    <div><label>DPO Name</label><input type="text" id="dpoName" class="upper"></div>
                    <div><label>Father Name</label><input type="text" id="dpoFather" class="upper"></div>
                </div>
                <div class="form-row">
                    <div><label>PAN (Deductor)</label><input type="text" id="dpoPan" maxlength="10" class="upper"></div>
                    <div><label>TAN (Deductor)</label><input type="text" id="dpoTan" maxlength="10" class="upper"></div>
                </div>
                <button class="btn btn-primary" onclick="next(1)">Next ‚ûî</button>
            </div>

            <div id="p2" class="page">
                <div class="form-group"><label>Teacher Name *</label><input type="text" id="tName" class="upper"></div>
                <div class="form-row" style="margin-top:15px">
                    <div><label>UDISE Code</label><input type="number" id="udise"></div>
                    <div><label>PAN (Teacher) *</label><input type="text" id="tPan" maxlength="10" class="upper"></div>
                </div>
                <div class="form-group"><label>School Name *</label><input type="text" id="school" class="upper"></div>
                <div class="form-row" style="margin-top:15px">
                    <div>
                        <label>Teacher Type</label>
                        <select id="tType">
                            <option value="Exclusive Teacher">Exclusive Teacher</option>
                            <option value="School Teacher">School Teacher (BPSC)</option>
                            <option value="Niyojit Teacher">Niyojit Teacher</option>
                            <option value="custom">Others</option>
                        </select>
                    </div>
                    <div><label>Class Category</label><select id="tClass"><option value="1-5">1-5</option><option value="6-8">6-8</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="next(2)">Next ‚ûî</button>
                <button class="btn btn-secondary" onclick="prev(2)">Back</button>
            </div>

            <div id="p3" class="page">
                <div class="form-row">
                    <div><label>Basic (Last Dec 2025)</label><input type="number" id="bDec" value="31670"></div>
                    <div><label>Increment Month</label><select id="incM"><option value="January">January</option><option value="July">July</option></select></div>
                </div>
                <div class="form-row">
                    <div>
                        <label>HRA Rate (%)</label>
                        <select id="hraP">
                            <option value="4">4%</option><option value="6">6%</option><option value="8">8%</option><option value="16">16%</option>
                            <option value="custom">Others</option>
                        </select>
                    </div>
                    <div><label>DA Rate (Jul-Feb) %</label><input type="number" id="daP" value="58"></div>
                </div>
                <button class="btn btn-primary" onclick="generateMatrix()">Calculate Salary ‚ûî</button>
                <button class="btn btn-secondary" onclick="prev(3)">Back</button>
            </div>

            <div id="p4" class="page">
                <div id="mList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;"></div>
                <div class="form-row">
                    <div><label>Arrear Amt (Bank)</label><input type="number" id="arrB" value="0" oninput="calcFinal()"></div>
                    <div><label>NPS on Arrear</label><input type="number" id="arrN" value="0" oninput="calcFinal()"></div>
                </div>
                <button class="btn btn-primary" onclick="next(4)">Final Summary ‚ûî</button>
                <button class="btn btn-secondary" onclick="prev(4)">Back</button>
            </div>

            <div id="p5" class="page">
                <div class="summary-box">
                    <p>Gross Income: ‚Çπ <span id="sumGross">0</span></p>
                    <p>Total NPS: ‚Çπ <span id="sumNps">0</span></p>
                    <p><b>Taxable Income: ‚Çπ <span id="sumTax">0</span></b></p>
                </div>
                <button class="btn btn-primary" id="pdfBtn" style="background:#d32f2f; font-size: 18px;" onclick="generateCombinedPDF()">üìÑ Download 2-Page PDF</button>
                <button class="btn btn-secondary" onclick="prev(5)">Back</button>
            </div>
        </div>
    </div>

    <div id="pdf-wrapper"></div>

    <script>
        const dists = {
            "Gopalganj": {n:"SAHEB ALAM", f:"SHEIKH MANSOOR ALAM", p:"DCFPA5644N", t:"PTND01409C"},
            "Siwan": {n:"RAJNISH KUMAR JHA", f:"MANOJ JHA", p:"BSKPJ9303C", t:"PTND02879C"},
            "Patna": {n:"DPO ESTB PATNA", f:"-", p:"ABCDE1234F", t:"PTND00000C"}
        };

        const mtx = {
            "Exclusive Teacher": {"1-5":[25000,25750,26520,27320,28140,28980,29850,30750,31670,32620],"6-8":[28000,28840,29700,30600,31510,32460,33430,34440,35470,36530]},
            "Niyojit Teacher": {"1-5":[21290,21940,22600,23280,23980,24710,25450,26210,27010,27820]}
        };
        mtx["School Teacher"] = mtx["Exclusive Teacher"];

        let mData = []; 

        function loadDist() {
            const d = document.getElementById('district').value;
            document.getElementById('cDistDiv').style.display = (d === 'custom') ? 'block' : 'none';
            if(dists[d]) {
                document.getElementById('dpoName').value = dists[d].n;
                document.getElementById('dpoFather').value = dists[d].f;
                document.getElementById('dpoPan').value = dists[d].p;
                document.getElementById('dpoTan').value = dists[d].t;
            }
        }

        function generateMatrix() {
            const basic = parseInt(document.getElementById('bDec').value);
            const incM = document.getElementById('incM').value;
            const type = document.getElementById('tType').value;
            const cls = document.getElementById('tClass').value;
            const daR = parseFloat(document.getElementById('daP').value);
            const hraR = parseFloat(document.getElementById('hraP').value);
            
            const slab = (mtx[type] && mtx[type][cls]) ? mtx[type][cls] : [basic];
            const idx = slab.indexOf(basic);
            const prvB = idx > 0 ? slab[idx-1] : basic;
            const nxtB = idx < slab.length-1 ? slab[idx+1] : basic;

            mData = []; let listHtml = '';
            const ms = ["Mar-25","Apr-25","May-25","Jun-25","Jul-25","Aug-25","Sep-25","Oct-25","Nov-25","Dec-25","Jan-26","Feb-26"];
            
            ms.forEach((m, i) => {
                let b = basic; 
                if(incM === "January") b = (i < 10) ? basic : nxtB;
                else b = (i < 4) ? prvB : basic;

                let dP = (i < 4) ? 55 : daR; 
                let daV = Math.round(b * dP / 100);
                let hraV = Math.round(b * hraR / 100);
                let ptax = (m === "Sep-25") ? 1000 : 0;
                
                mData.push({ m, b, dP, daV, hraV, ma:1000, nps:Math.round((b+daV)*0.1), ptax, gli:30 });
                listHtml += `<div style="border:1px solid #ddd; padding:10px; margin-bottom:5px; border-radius:5px; font-size:12px">
                    <b>${m}:</b> Pay ${b} | DA ${daV} (${dP}%) | NPS ${Math.round((b+daV)*0.1)}
                </div>`;
            });
            document.getElementById('mList').innerHTML = listHtml;
            calcFinal(); next(3);
        }

        function calcFinal() {
            let gross = mData.reduce((s, x) => s + x.b + x.daV + x.hraV + x.ma, 0);
            let nps = mData.reduce((s, x) => s + x.nps, 0);
            let arrB = parseInt(document.getElementById('arrB').value) || 0;
            let arrN = parseInt(document.getElementById('arrN').value) || 0;
            document.getElementById('sumGross').innerText = (gross + arrB).toLocaleString('en-IN');
            document.getElementById('sumNps').innerText = (nps + arrN).toLocaleString('en-IN');
            document.getElementById('sumTax').innerText = Math.max(0, gross + arrB - 75000 - 1000).toLocaleString('en-IN');
        }

        function next(p) { 
            document.getElementById('p'+p).classList.remove('active'); 
            document.getElementById('p'+(p+1)).classList.add('active'); 
            document.getElementById('s'+(p+1)).classList.add('active');
            sendHeight(); 
        }
        function prev(p) { 
            document.getElementById('p'+p).classList.remove('active'); 
            document.getElementById('p'+(p-1)).classList.add('active'); 
            sendHeight(); 
        }

        async function generateCombinedPDF() {
            const btn = document.getElementById('pdfBtn'); btn.innerText = "Merging Pages...";
            
            // New filenames integrated here
            const p1Res = await fetch('gtdsp1.html');
            const p2Res = await fetch('gtdsp2.html');
            
            const wrapper = document.getElementById('pdf-wrapper');
            wrapper.style.display = 'block';
            wrapper.innerHTML = (await p1Res.text()) + '<div style="page-break-before: always;"></div>' + (await p2Res.text());

            const payload = {
                districtName: document.getElementById('district').value === 'custom' ? document.getElementById('distName').value : document.getElementById('district').value,
                financialYear: "2025-26",
                dpoName: document.getElementById('dpoName').value,
                deductorPAN: document.getElementById('dpoPan').value,
                employeeName: document.getElementById('tName').value,
                employeePAN: document.getElementById('tPan').value,
                monthlyData: mData,
                arrearAmount: document.getElementById('arrB').value,
                arrearNPS: document.getElementById('arrN').value
            };

            setTimeout(() => {
                // Populate Page 1
                if(window.populateForm16) window.populateForm16(payload);
                // Populate Page 2
                if(window.populateForm16Page2) window.populateForm16Page2(payload);

                html2pdf().from(wrapper).set({ margin:0, filename:'Form16_Complete.pdf' }).save().then(() => {
                    wrapper.style.display = 'none'; btn.innerText = "üìÑ Download 2-Page PDF";
                });
            }, 1000);
        }

        function sendHeight() { window.parent.postMessage({ setHeight: document.body.scrollHeight }, '*'); }
        window.onload = sendHeight;
    </script>
</body>
</html>
